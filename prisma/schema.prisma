generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Kullanıcı ve Yetkilendirme
model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  createdPersons    Person[]     @relation("CreatedBy")
  createdCompanies  Company[]    @relation("CreatedBy")
  createdCourses    Course[]     @relation("CreatedBy")
  announcements     Announcement[]
  
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
  INSTRUCTOR
}

// Kişi Yönetimi
model Person {
  id                String          @id @default(cuid())
  firstName         String
  lastName          String
  email             String?         @unique
  phone             String?
  identityNumber    String?         @unique
  birthDate         DateTime?
  gender            Gender?
  address           String?
  city              String?
  district          String?
  postalCode        String?
  notes             String?
  source            String?         // Nereden geldi (referans, web, sosyal medya, vb.)
  tags              String[]        // Etiketler
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  createdById       String
  
  // Relations
  createdBy         User            @relation("CreatedBy", fields: [createdById], references: [id])
  company           Company?        @relation(fields: [companyId], references: [id])
  companyId         String?
  registrations     Registration[]
  attendances       Attendance[]
  examResults       ExamResult[]
  communications    Communication[]
  
  @@map("persons")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// Firma Yönetimi
model Company {
  id                String    @id @default(cuid())
  name              String
  taxNumber         String?   @unique
  taxOffice         String?
  email             String?
  phone             String?
  website           String?
  address           String?
  city              String?
  district          String?
  sector            String?   // Sektör
  employeeCount     Int?
  notes             String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdById       String
  
  // Relations
  createdBy         User      @relation("CreatedBy", fields: [createdById], references: [id])
  persons           Person[]
  registrations     Registration[]
  
  @@map("companies")
}

// Eğitim Yönetimi
model Course {
  id                String         @id @default(cuid())
  name              String
  code              String         @unique
  description       String?
  categoryId        String?
  category          CourseCategory? @relation(fields: [categoryId], references: [id])
  duration          Int            // Süre (saat)
  capacity          Int            // Kapasite
  price             Decimal        @db.Decimal(10, 2)
  startDate         DateTime
  endDate           DateTime
  schedule          String?        // Ders programı
  instructor        String?
  location          String?
  status            CourseStatus   @default(PLANNED)
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  createdById       String
  
  // Relations
  createdBy         User           @relation("CreatedBy", fields: [createdById], references: [id])
  registrations     Registration[]
  attendances       Attendance[]
  exams             Exam[]
  
  @@map("courses")
}

model CourseCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  color       String?  // UI için renk
  icon        String?  // Icon kodu
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  courses     Course[]
  
  @@map("course_categories")
}

enum CourseStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

// Kayıt Yönetimi
model Registration {
  id                String             @id @default(cuid())
  personId          String
  person            Person             @relation(fields: [personId], references: [id])
  courseId          String
  course            Course             @relation(fields: [courseId], references: [id])
  companyId         String?
  company           Company?           @relation(fields: [companyId], references: [id])
  registrationDate  DateTime           @default(now())
  status            RegistrationStatus @default(POTENTIAL)
  paymentStatus     PaymentStatus      @default(PENDING)
  totalAmount       Decimal            @db.Decimal(10, 2)
  paidAmount        Decimal            @default(0) @db.Decimal(10, 2)
  discount          Decimal?           @db.Decimal(10, 2)
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  payments          Payment[]
  
  @@map("registrations")
}

enum RegistrationStatus {
  POTENTIAL
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

// Mali İşlemler
model Payment {
  id              String        @id @default(cuid())
  registrationId  String
  registration    Registration  @relation(fields: [registrationId], references: [id])
  amount          Decimal       @db.Decimal(10, 2)
  paymentDate     DateTime      @default(now())
  paymentMethod   PaymentMethod
  receiptNumber   String?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("payments")
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  OTHER
}

model Expense {
  id          String        @id @default(cuid())
  description String
  amount      Decimal       @db.Decimal(10, 2)
  category    String
  expenseDate DateTime
  invoiceNo   String?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@map("expenses")
}

// Yoklama Sistemi
model Attendance {
  id           String           @id @default(cuid())
  courseId     String
  course       Course           @relation(fields: [courseId], references: [id])
  personId     String
  person       Person           @relation(fields: [personId], references: [id])
  date         DateTime
  status       AttendanceStatus
  notes        String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  
  @@unique([courseId, personId, date])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// Sınav Sistemi
model Exam {
  id          String       @id @default(cuid())
  courseId    String
  course      Course       @relation(fields: [courseId], references: [id])
  examCode    String       @unique  // Unique code for students to access exam
  title       String
  description String?
  examDate    DateTime
  duration    Int          // Dakika
  totalScore  Int
  passingScore Int
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  questions   Question[]
  results     ExamResult[]
  
  @@map("exams")
}

model Question {
  id            String         @id @default(cuid())
  examId        String
  exam          Exam           @relation(fields: [examId], references: [id])
  questionText  String
  questionType  QuestionType
  options       Json?          // Çoktan seçmeli için şıklar
  correctAnswer String
  points        Int
  order         Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@map("questions")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

model ExamResult {
  id        String   @id @default(cuid())
  examId    String
  exam      Exam     @relation(fields: [examId], references: [id])
  personId  String
  person    Person   @relation(fields: [personId], references: [id])
  score     Int
  isPassed  Boolean
  answers   Json?    // Verilen cevaplar
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([examId, personId])
  @@map("exam_results")
}

// İletişim ve Duyurular
model Announcement {
  id          String           @id @default(cuid())
  title       String
  content     String
  type        AnnouncementType
  priority    Priority         @default(NORMAL)
  targetGroup String[]         // Hedef kitle etiketleri
  publishDate DateTime         @default(now())
  expiryDate  DateTime?
  isActive    Boolean          @default(true)
  createdById String
  createdBy   User             @relation(fields: [createdById], references: [id])
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  @@map("announcements")
}

enum AnnouncementType {
  GENERAL
  COURSE
  EXAM
  PAYMENT
  EVENT
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Communication {
  id             String             @id @default(cuid())
  personId       String
  person         Person             @relation(fields: [personId], references: [id])
  type           CommunicationType
  subject        String?
  content        String
  status         CommunicationStatus @default(SENT)
  sentDate       DateTime           @default(now())
  deliveryStatus String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  
  @@map("communications")
}

enum CommunicationType {
  EMAIL
  SMS
  PHONE
  IN_PERSON
  OTHER
}

enum CommunicationStatus {
  DRAFT
  SENT
  DELIVERED
  FAILED
  REPLIED
}

// Sistem Ayarları ve Loglar
model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("system_settings")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity    String   // Entity adı (User, Person, Course, vb.)
  entityId  String?
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@map("audit_logs")
  @@index([userId, createdAt])
  @@index([entity, entityId])
}
